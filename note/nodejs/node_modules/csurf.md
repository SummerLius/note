## csurf


### 示例

```javascript
const csurf = require('csurf');

app.use(csurf({
    cookie: {
        key: 'csrf_herojoys'
    },
    ignoreMethods: ['GET', 'HEAD', 'OPTIONS']
}));
```


### csurf校验逻辑及配置

csurf中间件校验请求使用两个字符串：csrf-secret（后端存储）和csrf-token（前端存储）。

每次HTTP请求时，服务端获取请求中的csrf-token，并和存储在后端的csrf-secret值相校验。

关于csrf-secret的后端存储方式，默认是存储在req.session中，也可以根据配置存储在cookie中，这样的话其实也是将scrf-secret存储在前端了，不是太安全，建议存储在后端req.session中。

- cookie：boolean/object，默认false，如果设置了cookie不为false，则是将csrf-secret存储在cookie没有存储在后端session中
- sessionKey：string，默认'session'
- ignoreMethods：array，默认['GET', 'HEAD', 'OPTIONS']



### 中间件逻辑

`app.use(csurf(config))`逻辑：
1. 获取csrf-secret，从cookies或session中获取
    - 如果无csrf-secret值，则当即随机生成，并存储在cookies或session中
2. 获取HTTP请求中的csrf-token值
3. 如果HTTP方法不在ignoreMethods中，则执行校验，tokens.verify(csrf-secret, csrf-token)
4. 校验成功或校验忽略的执行next()通过，否者抛出错误。

`req.csrfToken()`逻辑:
1. 该方法作用为：根据csrf-secret生成一个对应的csrf-token，这个csrf-token是返回给前端使用的

### 校验实际情况

对于需要校验的HTTP方法，例如POST，其请求必须带上csrf-token，其对应的csrf-secret存储在后端，不对外公开且动态变化(session失效时，重新生成一个新的)，所以可以基本防范**跨站请求伪造**攻击。



