
## cookie-parser

`cookie-parser`node包，虽然从`express`框架剥离出来单独形成中间件，但是实际上从功能上还是不可分离的，即只要使用express则必须引用cookie-parser中间件。

为什么这么说呢，因为可以看源码得知：

`express`的res.cookie方法生成cookie和`cookie-parser`解析cookie，一个生成cookie，一个解析cookie，两个约定的算法是相互对应的。

### body-parser部分

```javascript
var cookie = require('cookie');
var signature = require('cookie-signature');

/**
 * 逻辑：
 *
 *      1. 增加req三个属性：
 *           req.secret
 *           req.cookies
 *           req.signedCookies 
 *      2. 是否存在cookie，不存在，直接next()，存在，下一步
 *      3. 解析req.headers.cookie -> req.cookies
 *      4. 中间件cookieParser(secret, options)，是否传入secret参数，
 *         若存在，则解析并验证签名cookie给req.signedCookies，若验证
 *         签名失败的key，赋值为false
 *
 *      无论是否存在secret，都不影响req.cookies正常的状态及使用，只是
 *      存在secret时，会将req.headers.cookie验证签名后，赋值给req.sigendCookies
 *
 *
 */
function cookieParser(secret, options) {
  return function cookieParser(req, res, next) {
    if (req.cookies) {
      return next();
    }

    var cookies = req.headers.cookie;
    var secrets = !secret || Array.isArray(secret)
      ? (secret || [])
      : [secret];

    req.secret = secrets[0];
    req.cookies = Object.create(null);
    req.signedCookies = Object.create(null);

    // no cookies
    if (!cookies) {
      return next();
    }

    req.cookies = cookie.parse(cookies, options);

    // parse signed cookies
    if (secrets.length !== 0) {
      req.signedCookies = signedCookies(req.cookies, secrets);
      req.signedCookies = JSONCookies(req.signedCookies);
    }

    // parse JSON cookies
    req.cookies = JSONCookies(req.cookies);

    next();
  };
}
```

### express部分

```javascript
var cookie = require('cookie');
var sign = require('cookie-signature').sign;


res.clearCookie = function clearCookie(name, options) {
  var opts = merge({ expires: new Date(1), path: '/' }, options);

  return this.cookie(name, '', opts);
};

res.cookie = function (name, value, options) {
  var opts = merge({}, options);
  var secret = this.req.secret;
  var signed = opts.signed;

// 当设置signed为true时，必须要事先存在req.secret，这个值在中间件body-parser会设置

  if (signed && !secret) {
    throw new Error('cookieParser("secret") required for signed cookies');
  }

// 支持处理cookie的value为对象，将objec序列化，并在前面增加"j:"两个字符标识，这个
// 标识约定，在cookie-parser中间件是一致的

  var val = typeof value === 'object'
    ? 'j:' + JSON.stringify(value)
    : String(value);

// 支持 signed 签名，防止客户端擅自更改cookie值

  if (signed) {
    val = 's:' + sign(val, secret);
  }

  if ('maxAge' in opts) {
    opts.expires = new Date(Date.now() + opts.maxAge);
    opts.maxAge /= 1000;
  }

  if (opts.path == null) {
    opts.path = '/';
  }

  this.append('Set-Cookie', cookie.serialize(name, String(val), opts));

  return this;
};
```





