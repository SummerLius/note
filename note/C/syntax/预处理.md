# 预处理器

功能及预处理指令：
- 宏定义：
    - `#define`：定义一个宏
    - `#undef`：删除一个宏定义
- 文件包含：
    - `#include`：指定一个文件，将其内容插入当前文件中
- 条件编译：预处理器根据预处理指令可以用来确定一段文本块包含到程序中还是排除到程序外
    - `#if`
    - `#ifdef`
    - `#ifndef`
    - `#elif`
    - `#else`
    - `#endif`
- 其它：
    - `#error`
    - `#line`
    - `#pragma`

预处理命令的一些规则说明：
- **都以#开始**。不需要是行首，只需前面是空白即可。
- **在指令的符号之间可以插入任意数量的空格或水平制表符**。
- **指令总是在第一个换行符处结束，除非使用反斜杠\指明延续**。
- **指令可以出现在程序任何地方**。但通常将#define和#include放在文件开始。
- **注释可以与指令放在同一行**。
- **注意所有预处理指令语句后面不要接分号;**

```c
// 中间多个空白，是合法的
#       define N     100;

// 延续一行使用反斜杠\
#define A (1 * \
           2 * \
           3)

// 以下都是错误Wrong，不要带分号
#include<stdio.h>;// 错误
#define N 100;// 错误
```

## 宏定义

### 简单的宏

格式：**`#define 标识符 替换列表`**
- 宏的替换列表：其实什么都可以替换，因为预处理根本不涉及语法理解，仅作文本替换而已
    - 标识符
    - 关键字
    - 数值常量
    - 字符常量
    - 字符串字面量
    - 操作符
    - 排列（这是啥）
    - ...
    - 啥都可以，只要替换后符合C语法

简单的宏主要用来定义那些称为“明示常量”或“符号常量”的东西，即用一个符号来表示C常量。这样的做的好处有：
- 程序更易读。
- 程序易于更改。
- 可帮助避免前后不一致或键盘输入错误。例如3.14159大量出现时，某些地方可能输入不一致。
- 可以对C语法做小修改。
- 对类型重命名。
- 控制条件编译。

```c
// 为一些常量给一个易读的标识符，即明示常量、符号常量
#define PI 3.14159
#define EOS '\0'
#define TRUE 1
#define FALSE 0

// c语法的小修改
#define BEGIN (
#define END )
#define LOOP for(;;)

// 重命名类型
#define BOOL int
```

### 带参数的宏

带参数的宏，也称函数式宏。

格式：**`#define 标识符(x1,x2,...,xn) 替换列表`**
- 宏的名字和左括号之间必须**没有空格**，否者会认为是简单的宏。
- 这样宏使用的方式像函数一样，所以称为函数式宏。

示例：
```c
// 定义
#define MAX(x,y)  ((x)>(y)?(x):(y))
#define IS_EVEN(n) ((n)%2==0)

// 使用
i = MAX(j+k, m-n);
if (IS_EVEN(n)) i++;
```


使用函数式宏替代真正的函数有以下优缺点：

优点：
- **程序稍微快一点**。程序调用函数通常会有一点额外开销。但是c99标准提供的，内联函数，为我们提供了一种不使用宏而避免这一开销的办法。
- **宏更“通用”**。宏的参数是没有类型的。例如上面例子中的MAX(x,y)，参数可以为int、long、float、double等。

缺点：
- **编译后的代码通常会变大**。每一处宏的调用都会导致插入宏的替换列表，由此导致源代码增加。
- **嵌套使用函数式宏可能会造成错误**。为了安全，最好对整体和参数都使用(括号)括起来。
- **宏参数没有类型检查**。
- **无法用一个指针来指向宏**。c语言允许指针指向函数，这些在特点编程条件是有用的。而宏在预处理过程中会被删除，所以不存在指向宏的指针，不能处理有关函数指针的特定编程。
- **宏可能会不止一次的计算它的参数**。多次计算宏的参数而导致的错误可能非常难发现，最好避免带有副作用的参数，例如i++，++i等。

```c
// 嵌套使用，没有使用括号造成的问题
#define MAX_1(x,y) ((x)>(y)?(x):(y))
#define MAX_2(x,y) x>y?x:y

int v1 = MAX_1(1, MAX_1(2, 3));
int v2 = MAX_2(1, MAX_2(2, 3));

```



## 条件编译

## 参考

- 《C语言程序设计 现代方法 第二版》